---
title: "Prepping population data"
output: html_document
date: '2022-09-07'
---

#Data Source
**Reference**: Olen and Lehsten 2022, https://www.sciencedirect.com/science/article/pii/S2352340922000166
**Downloaded**: 9/2022
**Description**:  Population count per cell, modelled to be consistent with both the CMIP6 RCP-specific urban fraction dataset (LUH2-v2f, luh.umd.edu) and the country level SSP population and urban fraction scenarios from the SSP database 
**Native data resolution**: 30 arcseconds (~1km equator) 
**Time range**: projection 2010-2100 (SSP1_2.6, SSP2_3.4, SSP3_7.0, SSP4_3.4, SSP5_8.5), yearly
**Format**:  tif


##Setup  

```{r setup,message=FALSE,warning=FALSE,verbose=FALSE}
#set options for all chunks in code
knitr::opts_chunk$set(warning=FALSE, message=FALSE,fig.width=6, fig.height=6)
#libraries
library(maps)
library(tidyverse)
library(RColorBrewer)
library(terra)
library(here)

# color
cols = rev(colorRampPalette(brewer.pal(9, 'Spectral'))(255)) # rainbow color scheme

# spatial map data
ocean_raw <- terra::rast(here("_spatial/ocean_area_mol.tif"))
ocean <- ocean_raw
ocean[ocean >0] <- 1

## need land area
prop_land <- 1-ocean_raw 
prop_land[is.na(prop_land)] <- 1
land_area_km2 <- prop_land*100 # each cell is 100 km2

## boundary mask
boundary_mask <- rast(nrow=2160, ncol=4320, xmin=-180, xmax=180, ymin=-90, ymax=90)
values(boundary_mask) <- 1
boundary_mask_mol <- terra::project(boundary_mask, "+proj=moll", res=10000)

plot(boundary_mask_mol)

```

## Defining years to use
```{r}
years_select <- data.frame(
  time_frame = c("current", "near-term", "medium-term", "long-term"),
  year_range = c("2010:2020",
                 "2021:2040",
                 "2041:2060",
                 "2081:2100"))

scenarios <- c("SSP1_RCP2_6", 
               "SSP2_RCP4_5",
               "SSP3_RCP7",
               "SSP4_RCP3_4",
               "SSP4_RCP6",
               "SSP5_RCP8_5")

```


Explore: can be skipped
```{r}

# see what is in directory
files <- dir("/home/shares/ohi/stressors_2021/_raw_data/olen_population", full=TRUE)

pop <- raster::raster(files[1]) 
raster::cellStats(pop, "sum", na.rm=TRUE)
## world population in 2010 was 6.922 billion (worldbank)
## estimate here: 6.872, looks good!
plot(log(pop+1))

```


## Function to prep raster
```{r}
#terraOptions(progress=0)

#dir.create("/home/shares/ohi/stressors_2021/_dataprep/population")
prep_rast <- function(scen = "SSP5_RCP8_5"){ # scen = scenarios[1]
    for(yrs in years_select$year_range){ # yrs = years_select$year_range[1]
  file_years <- eval(parse(text=paste0("c(", yrs, ")")))
  file_years <- paste0("count", file_years, collapse = "|")
  
  all_files <- list.files("/home/shares/ohi/stressors_2021/_raw_data/olen_population", full=TRUE)
  subset_files <- grep(scen, all_files, value=TRUE)
  subset_files <- grep(file_years, subset_files, value=TRUE)
  
  stack_rasters <- terra::rast(subset_files)
  cat(scen, ", ", yrs, ",  N=", length(subset_files), "\n")
  
  # get mean number of people per cell across relevant window of years
  avg_pop <- terra::app(stack_rasters, "mean", na.rm=FALSE, progress=0)
  
  # aggregate the data to be similar to our target resolution
  avg_pop_agg <- terra::aggregate(avg_pop, fact=10, fun="sum", na.rm=TRUE)
  
  # convert to density (people/km2) in order to saftly project
  avg_pop_density <- avg_pop_agg/terra::cellSize(avg_pop_agg)
  avg_density_mol <- terra::project(avg_pop_density, ocean)
  
  # convert back to number of people per cell after projecting
  avg_pop_mol <- avg_density_mol*10000*10000
  
  #calculate density (people per km2) using the actual land area, accounting for area of land in cells that land on ocean and land
  shoreline_density_km2 <- avg_pop_mol/land_area_km2
  
  # some points have people but no land, these are Infs. Checking it out here.
  # Doesn't seem to be a large number...convert these to NA values.
# inf_vals <- ifel(is.infinite(shoreline_density_km2), 1, NA)
#plot(inf_vals)
#  global(invals, sum, na.rm=TRUE)
#  plot(ocean_moll_sf, add=TRUE, color=NA)
#  people <- inf_vals*avg_pop_mol
#  global(people, sum, na.rm=TRUE)
#  global(avg_pop_mol, sum, na.rm=TRUE)
  
  shoreline_density_km2 <- ifel(is.infinite(shoreline_density_km2), NA, shoreline_density_km2)
  
  ## get the offshore density estimate, average of nearby land cells
  offshore_density_km2 <- terra::focal(shoreline_density_km2, w=3, fun=mean, na.rm=TRUE, na.policy="only")
      
  offshore_density_km2 <- offshore_density_km2*ocean 
    
# check that things look ok!    
#  extent <- terra::ext(1e7, 1.25e7, 3e6, 5e6)  
#plot(terra::crop(log(shoreline_density_km2+1), extent))
#plot(terra::crop(log(offshore_density_km2+1), extent))
      
  ## combine shoreline and offshore regions
  total <- terra::ifel(is.na(shoreline_density_km2), offshore_density_km2, shoreline_density_km2)  
    
  #plot(terra::crop(log(total+1), extent))

  terra::writeRaster(total, filename=sprintf("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand/human-pop-density-km2_%s_%s.tif",
              gsub(":", "_", yrs), scen), overwrite=TRUE)

  }
  }
# this many cells at native resolution: 722520000
# after agg: 1673*4320
# population: 7205132735

```

Run function on all scenarios.
```{r}
for(scenario in scenarios[4:6]){ #scenario= scenarios[1]
  prep_rast(scen=scenario)
  }

```

## We interupt this program....
Here I am going to save 2 additional iterations on the population data that will be useful for predicting other pressures (such as, light pollution).

1. Population density not extended into the ocean.
2. Population density with ocean gapfilled.

```{r}
# land only

land_cells <- ifel(prop_land>0, 1, NA)

file_list <- list.files("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand/", full=TRUE)

for(file in file_list){
  # file = file_list[1]
land_only <- terra::rast(file) 
# check that things look ok!    
#  extent <- terra::ext(1e7, 1.25e7, 3e6, 5e6)  
#plot(terra::crop(log(land_only+1), extent))
file_name <- basename(file)
file_name <- gsub("-km2", "-km2_land", file_name)

land_only <- land_cells * land_only
#plot(terra::crop(log(land_only+1), extent))

  terra::writeRaster(land_only, filename=sprintf("/home/shares/ohi/stressors_2021/_dataprep/population/other_pop_files/%s", file_name), overwrite=TRUE)
}

```

Ocean only, which is gapfilled based on nearby land values (I'm not sure this will be useful for predicting other variables, but I am going to give it a try).

```{r}

ocean_cells <- ifel(is.na(land_cells), 1, NA)

file_list <- list.files("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand/", full=TRUE)

# gapfill ocean area

for(file in file_list){
  # file = file_list[1]
ocean_only <- terra::rast(file) 
# check that things look ok!    
#  extent <- terra::ext(1e7, 1.25e7, 3e6, 5e6)  
#plot(terra::crop(log(land_only+1), extent))
file_name <- basename(file)
file_name <- gsub("-km2", "-km2_ocean-gf", file_name)

# gapfill 10 cells out into the ocean - using a fairly large window here.
ocean_gf <- ocean_only
for(i in 1:10){
  i=1+i
ocean_gf <- terra::focal(ocean_gf, w=9, fun=mean, na.rm=TRUE, na.policy="only")
}
# plot(ocean_gf)

# smoothing those values to help get rid of streaks and blobs.
ocean_gf <- terra::focal(ocean_gf, w=9, fun=mean, na.rm=TRUE)

# plot(ocean_gf)

ocean_gf <- ocean_gf * ocean_cells
#  extent <- terra::ext(1e7, 1.15e7, 4e6, 5e6)  
#plot(terra::crop(log(ocean_gf+1), extent))

  terra::writeRaster(ocean_gf, filename=sprintf("/home/shares/ohi/stressors_2021/_dataprep/population/other_pop_files/%s", file_name), overwrite=TRUE)


}


```

## Back to our regularly scheduled program....

## Log transform data
This paper shows how log tranforming population data is linearly correlated with several stressors.
https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.1000606
```{r}
files <- list.files("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand/", full=TRUE)

for(file in files){
  # file <- files[1]
  file_name <- basename(file)
  file_name <- gsub("-km2", "-km2-log", file_name)
  
  raster <- terra::rast(file)
  ln_raster <- log(raster + 1)
  
    terra::writeRaster(ln_raster, filename=sprintf("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand_log/%s",
              file_name), overwrite=TRUE)
  
}
 
```

## Rescaling data

Ideally, we would want to rescale this based on something biologically meaningful,
for example, the relationship between human density and biological stress.

But I haven't been able to find anything. Given this, I will rescale these data based on a confidence interval.

Step 1: 
Create a mask so rescaling is based only on coastal rasters. 

```{r}

moll_crs <- '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m'

ocean_sf <- sf::read_sf(here('_spatial', 'ne_10m_ocean', 'ne_10m_ocean.shp'))

  ocean_moll_sf <- ocean_sf %>%
    sf::st_transform(crs = moll_crs)

ocean_moll_line <- sf::st_cast(ocean_moll_sf,"MULTILINESTRING")  
raster_coast <- terra::rasterize(ocean_moll_line, ocean, touches=TRUE) 
plot(raster_coast, col="red") 
#  extent <- terra::ext(1e7, 1.15e7, 4e6, 5e6)  
# plot(terra::crop(raster_coast, extent))

coastal_mask <- focal(raster_coast, w=3, "max", na.policy="only", na.rm=TRUE)

plot(coastal_mask, col="red")
# plot(terra::crop(coastal_mask, extent))
# plot(ocean_moll_sf, add=TRUE, color=NA)

```

Get scaling value from current year. 
(use only coastal cells to determine scaling value, 
but rescale all population data)

```{r}
# using this value as information to determine best quantile to use.
# how many coastal cells are there?
global(coastal_mask, sum, na.rm=TRUE)

rescale_raster <- terra::rast("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand_log/human-pop-density-km2-log_2010_2020_SSP1_RCP2_6.tif")

rescale_raster_coast <- rescale_raster*coastal_mask

extent <- terra::ext(1e7, 1.15e7, 4e6, 5e6) 
plot(terra::crop(rescale_raster_coast, extent))

## determine quantile value used for rescaling
global(rescale_raster_coast, fun= function(x) {quantile(x, probs=c(0.99, 0.999, 0.9999), na.rm=TRUE)})

test1 <- terra::ifel(rescale_raster_coast >= 10.33508, 1, NA)
plot(as.points(test1), col="red")
plot(ocean_moll_sf, add=TRUE, color=NA)

test2 <- terra::ifel(rescale_raster_coast >= 8.48, 1, NA)
plot(as.points(test2), col="red")
plot(ocean_moll_sf, add=TRUE, color=NA)


# will go with the 99.9th quantile value
rescale_value <- global(rescale_raster_coast, fun= function(x) {quantile(x, probs=c(0.999), na.rm=TRUE)})

```

## rescaling the data!
```{r}

files <- list.files("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand_log", full=TRUE)


for(file in files){
  #file <- files[1]
  save_name <- basename(file)
  save_name <- gsub("-log", "-log-rescaled", basename(file))
  
  tmp <- terra::rast(file)
  rescaled <- tmp/pull(rescale_value)
  rescaled <- ifel(rescaled > 1, 1, rescaled)
# plot(rescaled, col=cols)
  
 terra::writeRaster(rescaled, filename=sprintf("/home/shares/ohi/stressors_2021/_dataprep/population/pop_density_km2_ocean_expand_log_rescaled/%s",
              save_name), overwrite=TRUE)  
    
}

```

***

