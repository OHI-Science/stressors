---
title: "Downloading and prepping extreme air temperature events"
output: html_document
date: '2022-08-09'
---

I will be using NOAA downscaled daily temperature data to estimate days >35 and >40. I will also calculate wetbulb temperatures.


I originally attempted to use:
 - the Xu data (used for SST data), but this will not work for this purpose.
 - IPCC summaries

I format these data in two ways: 
1) proportion of days within a year (based on days) in which temperature exceeds 35.
2) proportion of months within a year in which at least 2 days exceed 35.
3) Wet bulb temps as well!

raw data save here: /home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale
information: https://www.nccs.nasa.gov/services/data-collections/land-based-products/nex-gddp-cmip6
https://www.nccs.nasa.gov/sites/default/files/NEX-GDDP-CMIP6-Tech_Note.pdf
temporal resolution: daily
spatial resolution: 0.25 degrees
Variables:
hurs: Near-Surface Relative Humidity
percentage

huss: Near-Surface Specific Humidity
dimensionless ratio (kg/kg)

pr: Precipitation (mean of the daily precipitation rate)
kg m-2 s-1

rlds:  Surface Downwelling Longwave Radiation
W m-2

rsds: Surface Downwelling Shortwave Radiation
W m-2

sfcWind: Daily-Mean Near-Surface Wind Speed
m s-1

tas: Daily Near-Surface Air Temperature
Degrees Kelvin

tasmax: Daily Maximum Near-Surface Air Temperature
Degrees Kelvin

tasmin: Daily Minimum Near-Surface Air Temperature
Degrees Kelvin

```{r setup, include=FALSE}
library(raster)
library(ncdf4)
library(here)
library(tidyverse)
library(foreach)
library(doParallel)



#year ranges and scenarios:
yr_range <- data.frame(time_frame = c("current", "near-term",  "medium-term", "long-term"),
                       years = c("2015:2020", "2021:2040", "2041:2060", "2081:2100"))

years <- c(1995:2014, 2015:2020, 2021:2040, 2041:2060, 2081:2100)

rast_base_10km_file <- terra::rast(here('_spatial/rast_base_mol_10km.tif'))
ocean <- terra::rast(here('_spatial/ocean_area_mol.tif'))
land_coast <- terra::ifel(ocean<1,  1, 0)
land <- terra::ifel(is.na(land_coast), 1, land_coast)
land_mask <- terra::ifel(land==1, 1, NA)
plot(land_mask)
```


Download relevant datasets
```{r}

raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"

#years = 2015:2020 
data_list <- read.csv("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/gddp-cmip6-files.csv") %>%
  filter(grepl("tasmax", fileURL)) %>%
  filter(grepl(paste(paste0("_", years, ".nc"), collapse="|"), fileURL)) %>%
  pull(fileURL)

# tasmax_day_CNRM-ESM2-1_ssp126_r1i1p1f2_gr_2043.nc
# tasmax_day_UKESM1-0-LL_ssp245_r1i1p1f2_gn_2040.nc
for(data in data_list[1:length(data_list)]){ # data=data_list[1]

cmip_url <- trimws(data)
save_loc <- file.path(raw_data_loc, basename(cmip_url))

download.file(cmip_url, save_loc)
cat("finished = ", cmip_url, "\n")

}

# check file sizes. If any look weird, resave:


weirds <- c("tasmax_day_CNRM-ESM2-1_ssp126_r1i1p1f2_gr_2043.nc", "tasmax_day_UKESM1-0-LL_ssp245_r1i1p1f2_gn_2040.nc")
weirds <- paste0(weirds, collapse = "|")
data_list <- read.csv("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/gddp-cmip6-files.csv") %>%
    filter(grepl(weirds, fileURL)) %>%
  pull(fileURL)

for(data in data_list[1:length(data_list)]){ # data=data_list[1]

cmip_url <- trimws(data)
save_loc <- file.path(raw_data_loc, basename(cmip_url))

download.file(cmip_url, save_loc)
cat("finished = ", cmip_url, "\n")

}

```

## mean of climate models 

### max temp
```{r}
raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"
raw_data_list <- list.files(raw_data_loc, full=TRUE)

file_list_basename <- list.files("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data")

combos <- data.frame(stringr::str_split_fixed(file_list_basename, "_", 7))[,c(3,4,7)] 

names(combos) <- (c("model", "scenario", "year"))


combos <- combos %>%
  mutate(year = gsub(".tif", "", year)) %>%
  filter(model %in% unique(model[scenario=="ssp370"]))

table(combos$scenario)
table(combos$model, combos$scenario)

included_models <- unique(combos$model)

scenario_list = c("ssp126", "ssp245", "ssp370", "ssp585")
year_list = paste0(c(2015:2020, 2021:2040, 2041:2060, 2081:2100), ".nc")

for(scenario in scenario_list){ # scenario = scenario_list[4]

scenario_files <- grep(scenario, raw_data_list, value=TRUE)
scenario_files <- grep("HadGEM3-GC31-LL|HadGEM3-GC31-MM|KACE|UKESM1", scenario_files, value=TRUE, invert=TRUE) # didn't have at least 365 days!
  
for(year in year_list){ #year = "2020.nc"
  ensemble_files <- grep(year, scenario_files, value=TRUE)
    n_ensemble_files <- length(ensemble_files)
  ensemble_files <- paste(ensemble_files, collapse=" ")

  saveFile <- sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble/tasmax_%s_%s_%s", n_ensemble_files, scenario, year)
  
cdo_command <- sprintf("cdo ensmean %s  %s", ensemble_files, saveFile)

system(cdo_command)
}
}

check <- terra::rast(list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble", full=TRUE)[1])



# now add in historical
scenario_list = c("historical")
year_list = paste0(c(1995:2014), ".nc")

for(scenario in scenario_list){ # scenario = scenarios[1]

scenario_files <- grep(scenario, raw_data_list, value=TRUE)
scenario_files <- grep("HadGEM3-GC31-LL|HadGEM3-GC31-MM|KACE|UKESM1", scenario_files, value=TRUE, invert=TRUE) # didn't have at least 365 days!
  
for(year in year_list){ #year = "2020.nc"
  ensemble_files <- grep(year, scenario_files, value=TRUE)
    n_ensemble_files <- length(ensemble_files)
  ensemble_files <- paste(ensemble_files, collapse=" ")

  saveFile <- sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble/tasmax_%s_%s_%s", n_ensemble_files, scenario, year)
  
cdo_command <- sprintf("cdo ensmean %s  %s", ensemble_files, saveFile)

system(cdo_command)
}
}

```

### humidity
```{r}
raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/humidity"
raw_data_list <- list.files(raw_data_loc, full=TRUE)

file_list_basename <- list.files("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/humidity")

combos <- data.frame(stringr::str_split_fixed(file_list_basename, "_", 7))[,c(3,4,7)] 

names(combos) <- (c("model", "scenario", "year"))

combos <- combos %>%
  mutate(year = gsub(".tif", "", year)) %>%
  filter(model %in% unique(model[scenario=="ssp370"]))

table(combos$scenario)
table(combos$model, combos$scenario)

included_models <- paste(unique(combos$model), collapse="|")

scenario_list = c("ssp126", "ssp245", "ssp370", "ssp585")
year_list = paste0(c(2015:2020, 2021:2040, 2041:2060, 2081:2100), ".nc")

for(scenario in scenario_list){ # scenario = scenarios[1]

scenario_files <- grep(scenario, raw_data_list, value=TRUE)
scenario_files <- grep(included_models, scenario_files, value=TRUE)
scenario_files <- grep("HadGEM3-GC31-LL|HadGEM3-GC31-MM|KACE|UKESM1", scenario_files, value=TRUE, invert=TRUE) # didn't have at least 365 days!
  
for(year in year_list){ #year = "2020.nc"
  ensemble_files <- grep(year, scenario_files, value=TRUE)
    n_ensemble_files <- length(ensemble_files)
  ensemble_files <- paste(ensemble_files, collapse=" ")

  saveFile <- sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/relhumidity_ensemble/humidity_%s_%s_%s", n_ensemble_files, scenario, year)
  
cdo_command <- sprintf("cdo ensmean %s  %s", ensemble_files, saveFile)

system(cdo_command)
}
}

check <- terra::rast(list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble", full=TRUE)[1])



# now add in historical
scenario_list = c("historical")
year_list = paste0(c(1995:2014), ".nc")

for(scenario in scenario_list){ # scenario = scenarios[1]

scenario_files <- grep(scenario, raw_data_list, value=TRUE)
scenario_files <- grep("HadGEM3-GC31-LL|HadGEM3-GC31-MM|KACE|UKESM1", scenario_files, value=TRUE, invert=TRUE) # didn't have at least 365 days!
  
for(year in year_list){ #year = "2020.nc"
  ensemble_files <- grep(year, scenario_files, value=TRUE)
    n_ensemble_files <- length(ensemble_files)
  ensemble_files <- paste(ensemble_files, collapse=" ")

  saveFile <- sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble/tasmax_%s_%s_%s", n_ensemble_files, scenario, year)
  
cdo_command <- sprintf("cdo ensmean %s  %s", ensemble_files, saveFile)

system(cdo_command)
}
}

```

### max temp
```{r}
raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"
raw_data_list <- list.files(raw_data_loc, full=TRUE)

file_list_basename <- list.files("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data")

combos <- data.frame(stringr::str_split_fixed(file_list_basename, "_", 7))[,c(3,4,7)] 

names(combos) <- (c("model", "scenario", "year"))


combos <- combos %>%
  mutate(year = gsub(".tif", "", year)) %>%
  filter(model %in% unique(model[scenario=="ssp370"]))

table(combos$scenario)
table(combos$model, combos$scenario)

included_models <- unique(combos$model)

scenario_list = c("ssp126", "ssp245", "ssp370", "ssp585")
year_list = paste0(c(2015:2020, 2021:2040, 2041:2060, 2081:2100), ".nc")

for(scenario in scenario_list){ # scenario = scenarios[1]

scenario_files <- grep(scenario, raw_data_list, value=TRUE)
scenario_files <- grep("HadGEM3-GC31-LL|HadGEM3-GC31-MM|KACE|UKESM1", scenario_files, value=TRUE, invert=TRUE) # didn't have at least 365 days!
  
for(year in year_list){ #year = "2020.nc"
  ensemble_files <- grep(year, scenario_files, value=TRUE)
    n_ensemble_files <- length(ensemble_files)
  ensemble_files <- paste(ensemble_files, collapse=" ")

  saveFile <- sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble/tasmax_%s_%s_%s", n_ensemble_files, scenario, year)
  
cdo_command <- sprintf("cdo ensmean %s  %s", ensemble_files, saveFile)

system(cdo_command)
}
}

check <- terra::rast(list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/tasmax_ensemble", full=TRUE)[1])

```



## 35 degree exceedance

The following code chunk is saved as Rscript (days35.R) so it can be run as a background job.
If I rerun this, alter so the files are not reprojected and gapfilled (that should be done at a later step
to speed processing.)
```{r}

raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"
nc_file_list <- list.files(raw_data_loc, full=TRUE)

threshold <- 273.15 + 35  # Change this to your desired threshold


for(nc_file in nc_file_list){ #nc_file = nc_file_list[1]
# Use lapply to apply a function to each layer of the raster

  tmp <- terra::rast(nc_file)  
  
layers <- lapply(1:dim(tmp)[3], function(i) { # i=1
  layer <- tmp[[i]]
  
  # Set values less than or equal to the threshold to 0
  layer <- ifel(layer < threshold, 0, 1)
  
  # Return the modified layer
  return(layer)
})


# Stack the layers back into a SpatRaster
r_threshold <- rast(layers)

# Sum the layers
r_sum <- sum(r_threshold)
#r_sum
#plot(r_sum)
  
sum_proj <- project(r_sum, rast_base_10km_file)

  sum_proj_gf <- sum_proj

for(i in 1:20){
  i=1+i
sum_proj_gf <- terra::focal(sum_proj_gf, w=3, fun=mean, na.rm=TRUE, na.policy="only")
cat(i, "\n")
}

sum_proj_gf <- land_mask*sum_proj_gf

prop_days <- sum_proj_gf/365
prop_days <- ifel(prop_days>1, 1, prop_days)

saveName <-  gsub(".nc", ".tif", basename(nc_file))
writeRaster(prop_days, filename = sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/%s", saveName), overwrite = TRUE)

}

```

Next average the models for each year and climate projection.

```{r}

file_list_basename <- list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/")

combos <- data.frame(stringr::str_split_fixed(file_list_basename, "_", 7))[,c(3,4,7)] 

names(combos) <- (c("model", "scenario", "year"))


combos <- combos %>%
  mutate(year = gsub(".tif", "", year)) %>%
  filter(model %in% unique(model[scenario=="ssp370"]))

table(combos$scenario)
table(combos$model, combos$scenario)

included_models <- unique(combos$model)

yr_scenarios <- combos %>%
  select("year", "scenario") %>%
  unique()

file_list <- list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/", full=TRUE)
file_list <- grep(paste(included_models, collapse="|"), file_list, value=TRUE)


for(i in 1:dim(yr_scenarios)[1]){ # i = 1
  year <- paste0(yr_scenarios$year[i], ".tif")
  scenario <- yr_scenarios$scenario[i]
  ensemble<- grep(scenario, file_list, value=TRUE)
  ensemble <- grep(year, ensemble, value=TRUE)
  cat("scenario = ", scenario, "  year = ", year, "  N = ", length(ensemble), "\n")
  ensemble_rasts <- terra::rast(ensemble)
  ensemble_mean <- mean(ensemble_rasts)
  writeRaster(ensemble_mean, sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/ensemble_prop_days_35C/days35_%s_%s", scenario, year), overwrite=TRUE)
}

```

Now average for the year ranges:
```{r}

yr_range
expand.grid(time_frame = c(yr_range$time_frame), 
            years = yr_range$years,
            scenario = c("ssp126", "ssp245", "ssp370", "ssp585"))

scen_times <- list.files("/home/shares/ohi/stressors_2021/_dataprep/T_air/ensemble_prop_days_35C")
```