---
title: "Downloading and prepping extreme air temperature events"
output: html_document
date: '2022-08-09'
---

I will be using NOAA downscaled daily temperature data to estimate days >35 and >40. I will also calculate wetbulb temperatures.


I originally attempted to use:
 - the Xu data (used for SST data), but this will not work for this purpose.
 - IPCC summaries

I format these data in two ways: 
1) proportion of days within a year (based on days) in which temperature exceeds 35.
2) proportion of months within a year in which at least 2 days exceed 35.
3) Wet bulb temps as well!

raw data save here: /home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale
information: https://www.nccs.nasa.gov/services/data-collections/land-based-products/nex-gddp-cmip6
https://www.nccs.nasa.gov/sites/default/files/NEX-GDDP-CMIP6-Tech_Note.pdf
temporal resolution: daily
spatial resolution: 0.25 degrees
Variables:
hurs: Near-Surface Relative Humidity
percentage

huss: Near-Surface Specific Humidity
dimensionless ratio (kg/kg)

pr: Precipitation (mean of the daily precipitation rate)
kg m-2 s-1

rlds:  Surface Downwelling Longwave Radiation
W m-2

rsds: Surface Downwelling Shortwave Radiation
W m-2

sfcWind: Daily-Mean Near-Surface Wind Speed
m s-1

tas: Daily Near-Surface Air Temperature
Degrees Kelvin

tasmax: Daily Maximum Near-Surface Air Temperature
Degrees Kelvin

tasmin: Daily Minimum Near-Surface Air Temperature
Degrees Kelvin

```{r setup, include=FALSE}
library(raster)
library(ncdf4)
library(here)
library(tidyverse)
library(foreach)
library(doParallel)



#year ranges and scenarios:
yr_range <- data.frame(time_frame = c("current", "near-term",  "medium-term", "long-term"),
                       years = c("1995:2014", "2021:2040", "2041:2060", "2081:2100"))

years <- c(1995:2014, 2021:2040, 2021:2040, 2041:2060, 2081:2100)

rast_base_10km_file <- terra::rast(here('_spatial/rast_base_mol_10km.tif'))
ocean <- terra::rast(here('_spatial/ocean_area_mol.tif'))
land_coast <- terra::ifel(ocean<1,  1, 0)
land <- terra::ifel(is.na(land_coast), 1, land_coast)
land_mask <- terra::ifel(land==1, 1, NA)
plot(land_mask)
```


Download relevant datasets
```{r}

raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"

data_list <- read.csv("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/gddp-cmip6-files.csv") %>%
  filter(grepl("tasmax", fileURL)) %>%
  filter(grepl(paste(paste0("_", years, ".nc"), collapse="|"), fileURL)) %>%
  pull(fileURL)

# tasmax_day_CNRM-ESM2-1_ssp126_r1i1p1f2_gr_2043.nc
# tasmax_day_UKESM1-0-LL_ssp245_r1i1p1f2_gn_2040.nc
for(data in data_list[1:length(data_list)]){ # data=data_list[1]

cmip_url <- trimws(data)
save_loc <- file.path(raw_data_loc, basename(cmip_url))

download.file(cmip_url, save_loc)
cat("finished = ", cmip_url, "\n")

}

# check file sizes. If any look weird, resave:


weirds <- c("tasmax_day_CNRM-ESM2-1_ssp126_r1i1p1f2_gr_2043.nc", "tasmax_day_UKESM1-0-LL_ssp245_r1i1p1f2_gn_2040.nc")
weirds <- paste0(weirds, collapse = "|")
data_list <- read.csv("/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/gddp-cmip6-files.csv") %>%
    filter(grepl(weirds, fileURL)) %>%
  pull(fileURL)

for(data in data_list[1:length(data_list)]){ # data=data_list[1]

cmip_url <- trimws(data)
save_loc <- file.path(raw_data_loc, basename(cmip_url))

download.file(cmip_url, save_loc)
cat("finished = ", cmip_url, "\n")

}

```


The following code chunk is saved as Rscript (days25.R) so it can be run as a background job.
```{r}

raw_data_loc <- "/home/shares/ohi/stressors_2021/_raw_data/NOAA_cmip6_land_downscale/data"
nc_file_list <- list.files(raw_data_loc, full=TRUE)

threshold <- 273.15 + 35  # Change this to your desired threshold


for(nc_file in nc_file_list){ #nc_file = nc_file_list[1]
# Use lapply to apply a function to each layer of the raster

  tmp <- terra::rast(nc_file)  
  
layers <- lapply(1:dim(tmp)[3], function(i) { # i=1
  layer <- tmp[[i]]
  
  # Set values less than or equal to the threshold to 0
  layer <- ifel(layer < threshold, 0, 1)
  
  # Return the modified layer
  return(layer)
})


# Stack the layers back into a SpatRaster
r_threshold <- rast(layers)

# Sum the layers
r_sum <- sum(r_threshold)
#r_sum
#plot(r_sum)
  
sum_proj <- project(r_sum, rast_base_10km_file)

  sum_proj_gf <- sum_proj

for(i in 1:20){
  i=1+i
sum_proj_gf <- terra::focal(sum_proj_gf, w=3, fun=mean, na.rm=TRUE, na.policy="only")
cat(i, "\n")
}

sum_proj_gf <- land_mask*sum_proj_gf

prop_days <- sum_proj_gf/365
prop_days <- ifel(prop_days>1, 1, prop_days)

saveName <-  gsub(".nc", ".tif", basename(nc_file))
writeRaster(prop_days, filename = sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/%s", saveName), overwrite = TRUE)



}


```



writeRaster(proj_scaled_raster, filename = sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/days-35_%s_%s.tif", scen, timeframe), overwrite = TRUE)

}

#historical
scen <- terra::rast("/home/shares/ohi/stressors_2021/_raw_data/Tair_35d_ipcc/CMIP6 - Bias Adjusted TX35  days - Near Term (2021-2040) SSP1-2.6  - Annual (24 models).tiff")
hist_diff <- terra::rast( "/home/shares/ohi/stressors_2021/_raw_data/Tair_35d_ipcc/CMIP6 - Bias Adjusted TX35 Change days - Near Term (2021-2040) SSP1-2.6 (rel. to 1995-2014) - Annual (24 models).tiff")
historical <- scen - hist_diff

scaled_historical <- historical/365

proj_scaled_historical <- terra::project(scaled_historical, rast_base_10km_file, method="near")
writeRaster(proj_scaled_historical, "/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_35C/days-35_NA_historical.tif", overwrite = TRUE)

```


40C
```{r}

# scenarios
for (file in yr_40_range$filename){ #file = yr_40_range$filename[1]

all_files <- list.files("/home/shares/ohi/stressors_2021/_raw_data/Tair_40d_ipcc", full=TRUE)

file_path <- grep(file, all_files, fixed=TRUE, value=TRUE)
cat("N= ", length(file_path), " raster file was discovered")

raster <- terra::rast(file_path)
scaled_raster <- raster/365

proj_scaled_raster <- terra::project(scaled_raster, rast_base_10km_file, method="near")

scen <- yr_40_range$scenario[yr_40_range$filename==file]
timeframe <-  yr_40_range$time_frame[yr_40_range$filename==file]

writeRaster(proj_scaled_raster, filename = sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_40C/days-40_%s_%s.tif", scen, timeframe), overwrite = TRUE)

}
#historical
scen <- terra::rast("/home/shares/ohi/stressors_2021/_raw_data/Tair_40d_ipcc/CMIP6 - Bias Adjusted TX40  days - Near Term (2021-2040) SSP1-2.6  - Annual (24 models).tiff")
hist_diff <- terra::rast( "/home/shares/ohi/stressors_2021/_raw_data/Tair_40d_ipcc/CMIP6 - Bias Adjusted TX40 Change days - Near Term (2021-2040) SSP1-2.6 (rel. to 1995-2014) - Annual (24 models).tiff")
historical <- scen - hist_diff

scaled_historical <- historical/365

proj_scaled_historical <- terra::project(scaled_historical, rast_base_10km_file, method="near")
writeRaster(proj_scaled_historical, "/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_days_40C/days-40_NA_historical.tif", overwrite = TRUE)

```

## Proportion of months

35C


First calculate exceedences (>= 2 days in a month) of the historical data.  

```{r}

all_files <- list.files("/home/shares/ohi/stressors_2021/_raw_data/Tair_35d_ipcc/monthly", full=TRUE)

month_list <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")

for(month in month_list){ # month = month_list[1]

# Define the directory where the files are located
directory <- "/home/shares/ohi/stressors_2021/_raw_data/Tair_35d_ipcc/monthly"
# Define the file name pattern
pattern <- paste0("CMIP6 - Bias Adjusted TX35  days - Near Term \\(2021-2040\\) SSP1-2\\.6  - ", month, " \\(.*models\\)\\.tiff$")
# List the files that match the pattern
scen_path <- list.files(path = directory, pattern = pattern, full=TRUE)
scen_raster <- terra::rast(scen_path)


pattern <- paste0("CMIP6 - Bias Adjusted TX35 Change days - Near Term \\(2021-2040\\) SSP1-2\\.6 \\(rel\\. to 1995-2014\\) - ", month, " \\(.*models\\)\\.tiff$")
hist_path <- list.files(path = directory, pattern = pattern, full=TRUE)
hist_diff_raster <- terra::rast(hist_diff)

cat("For month = ", month, ", hist_diff is = ", class(hist_diff_raster)[1], "and scen_raster is = ", class(scen_raster)[1], "\n")

historical <- scen_raster - hist_diff_raster
historical_exceed <- terra::ifel(historical>=2, 1, 0)

proj_exceed_historical <- terra::project(historical_exceed, rast_base_10km_file, method="near")


writeRaster(proj_exceed_historical, sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_months_35C/exceed_2days_monthly/month-exceed-35_%s_NA_historical.tif", month), overwrite = TRUE)
}

```


First calculate exceedences (>= 2 days in a month) of the other data.  

```{r}

all_files <- list.files("/home/shares/ohi/stressors_2021/_raw_data/Tair_35d_ipcc/monthly", full=TRUE, pattern = "TX35  days")


for(file in all_files){ # file = all_files[2]

saveName <- basename(file)
scen_raster <- terra::rast(file)
max_scen_raster <- terra::global(scen_raster, "max")$max
cat(saveName, " has max = ", max_scen_raster, "\n")

scen_raster_exceed <- terra::ifel(scen_raster>=2, 1, 0)

proj_exceed_scen <- terra::project(scen_raster_exceed, rast_base_10km_file, method="near")


writeRaster(proj_exceed_scen, sprintf("/home/shares/ohi/stressors_2021/_dataprep/T_air/proportion_months_35C/exceed_2days_monthly/month-exceed_%s", saveName), overwrite = TRUE)
}

```




