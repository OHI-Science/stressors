---
title: "Untitled"
output: html_document
date: "2024-09-12"
---

Going to use current pressure data and habitat distributions to determine how vulnerable some key habitats are to the air temperature pressure.

```{r setup, include=FALSE}
library(tidyverse)
library(terra)
library(here)
library(countrycode)

```

```{r}
sst <- rast("/home/shares/ohi/stressors_2021/_dataprep/SST/five_year_average_final/sst_avg_ssp245_2015_2019.tif")
sst <- sst-273.15

kelp <- rast(here("habitats/data/kelp.tif"))

stack <- c(sst, kelp)
stack_df <- data.frame(stack)

kelp <- stack_df %>%
  filter(!is.na(focal_mean)) %>%
  mutate(kelp = ifelse(is.na(kelp), 0, kelp))

Hmisc::wtd.quantile(kelp$focal_mean, weights=kelp$kelp,probs= c(0.001, 0.01, 0.1, 0.5, 0.90, 0.99, 0.999))

ggplot(kelp, aes(x=focal_mean, y=kelp)) +
  geom_point(size=0.2, alpha=0.5, height=0.1) +
  geom_smooth(method = "gam", se = TRUE) + 
  geom_hline(yintercept=0, color="red") + 
  ylab("kelp") +
  xlab("SST")


coral <- rast(here("habitats/data/coral-reef.tif"))

stack <- c(sst, coral)
stack_df <- data.frame(stack)

coral <- stack_df %>%
  filter(!is.na(focal_mean)) %>%
  mutate(coral_reef = ifelse(is.na(coral_reef), 0, coral_reef))

Hmisc::wtd.quantile(coral$focal_mean, weights=coral$coral_reef, probs= c(0.001, 0.01, 0.1, 0.5, 0.90, 0.95, 0.99, 0.999))

ggplot(coral, aes(x=focal_mean, y=coral_reef)) +
  geom_point(size=0.2, alpha=0.5, height=0.1) +
  geom_smooth(method = "gam", se = TRUE) + 
  geom_hline(yintercept=0, color="red") + 
  ylab("coral") +
  xlab("SST")


marsh <- rast(here("habitats/data/salt-marsh.tif")) 

stack <- c(sst, marsh) 

stack_df <- data.frame(stack)

marsh <- stack_df %>%
  filter(!is.na(focal_mean)) %>%
  mutate(salt_marsh = ifelse(is.na(salt_marsh), 0, salt_marsh))

Hmisc::wtd.quantile(marsh$focal_mean, weights=marsh$salt_marsh, probs= c(0.001, 0.01, 0.1, 0.5, 0.90, 0.99, 0.999))

ggplot(marsh, aes(x=focal_mean, y=salt_marsh)) +
  geom_point(size=0.2, alpha=0.5, height=0.1) +
  geom_smooth(method = "gam", se = TRUE) + 
  geom_hline(yintercept=0, color="red") + 
  ylab("marsh") +
  xlab("SST")


seagrass <- rast(here("habitats/data/seagrass.tif")) 

stack <- c(sst, seagrass) 

stack_df <- data.frame(stack)

seagrass <- stack_df %>%
  filter(!is.na(focal_mean)) %>%
  mutate(seagrass = ifelse(is.na(seagrass), 0, seagrass))

Hmisc::wtd.quantile(seagrass$focal_mean, weights=seagrass$seagrass, probs= c(0.001, 0.01, 0.1, 0.5, 0.90, 0.99, 0.999))

ggplot(seagrass, aes(x=focal_mean, y=seagrass)) +
  geom_point(size=0.2, alpha=0.5, height=0.1) +
  geom_smooth(method = "gam", se = TRUE) + 
  geom_hline(yintercept=0, color="red") + 
  ylab("seagrass") +
  xlab("SST")
